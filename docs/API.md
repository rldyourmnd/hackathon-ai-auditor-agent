# üöÄ Curestry API Documentation

## Overview

Curestry is an AI-powered prompt analysis and improvement system. The API provides endpoints for analyzing prompts, applying improvements, managing prompt-base, and exporting results.

**Base URL**: `http://localhost:8000`

---

## üìä Analysis Pipeline

### POST /analyze

Analyzes a prompt across multiple dimensions and returns comprehensive metrics.

**Request Body:**
```json
{
  "prompt": {
    "content": "Write a Python function that calculates fibonacci numbers",
    "format_type": "auto"
  }
}
```

**Response:**
```json
{
  "report": {
    "detected_language": "en",
    "translated": false,
    "format_valid": true,
    "semantic_entropy": 0.23,
    "semantic_spread": 0.45,
    "semantic_clusters": 3,
    "llm_judge_score": 7.5,
    "contradictions": [],
    "vocabulary_stats": {
      "complexity": 0.6,
      "consistency": 0.8
    }
  },
  "patches": [
    {
      "id": "clarity_1",
      "type": "safe",
      "category": "clarity",
      "description": "Add specification for recursion vs iteration",
      "original": "Write a Python function",
      "improved": "Write a Python function using recursion",
      "rationale": "Clarifies implementation approach",
      "confidence": 0.8
    }
  ],
  "questions": [
    {
      "id": "q_1",
      "text": "Should the function handle negative inputs?",
      "category": "constraints",
      "priority": "important"
    }
  ]
}
```

**Processing Pipeline:**
1. Language Detection ‚Üí Translation (if needed)
2. Format Validation ‚Üí Markup Linting
3. Vocabulary Analysis ‚Üí Contradiction Detection
4. Semantic Entropy Analysis ‚Üí LLM Judge Scoring
5. Patch Generation ‚Üí Clarification Questions

---

## üîß Improvement Application

### POST /apply

Applies selected patches to improve the prompt.

**Request Body:**
```json
{
  "prompt_id": "550e8400-e29b-41d4-a716-446655440000",
  "patch_ids": ["clarity_1", "structure_2"],
  "apply_all_safe": false
}
```

**Response:**
```json
{
  "improved_prompt": "Write a Python function using recursion that calculates fibonacci numbers efficiently",
  "applied_patches": ["clarity_1", "structure_2"],
  "success": true
}
```

**Patch Application Logic:**
- **Safe patches**: Applied automatically if `apply_all_safe: true`
- **Quality patches**: LLM-generated improvements replace entire prompt
- **Clarity patches**: Targeted improvements to specific sections

---

## ‚ùì Clarification System

### POST /clarify

Processes clarification answers and re-analyzes the prompt with enhanced context.

**Request Body:**
```json
{
  "prompt_id": "550e8400-e29b-41d4-a716-446655440000",
  "answers": [
    {
      "question_id": "q_1",
      "answer": "Yes, the function should return 0 for negative inputs"
    }
  ]
}
```

**Response:**
```json
{
  "report": {
    "detected_language": "en",
    "llm_judge_score": 8.2,
    "semantic_entropy": 0.18
  },
  "patches": [
    {
      "id": "constraint_1",
      "type": "safe",
      "description": "Add input validation for negative numbers",
      "improved": "def fibonacci(n):\n    if n < 0:\n        return 0"
    }
  ],
  "questions": [],
  "updated": true
}
```

---

## üì§ Export System

### GET /export/{prompt_id}.md

Exports the improved prompt in Markdown format.

**Response:**
```markdown
# Improved Prompt

Write a Python function using recursion that calculates fibonacci numbers efficiently.

## Requirements
- Handle negative inputs by returning 0
- Use recursive implementation
- Include input validation

## Analysis Metrics
- Judge Score: 8.2/10
- Semantic Entropy: 0.18
- Contradictions: 0

*Generated by Curestry AI Analysis Pipeline*
```

### GET /export/{prompt_id}.xml

Exports in structured XML format.

**Response:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<prompt_analysis>
  <content>Write a Python function using recursion that calculates fibonacci numbers efficiently</content>
  <metadata>
    <language>en</language>
    <format_type>text</format_type>
    <judge_score>8.2</judge_score>
    <semantic_entropy>0.18</semantic_entropy>
  </metadata>
  <improvements>
    <patch id="clarity_1" type="safe">
      <description>Add specification for recursion vs iteration</description>
    </patch>
  </improvements>
</prompt_analysis>
```

### GET /report/{prompt_id}.json

Downloads complete analysis report.

**Response:**
```json
{
  "prompt_id": "550e8400-e29b-41d4-a716-446655440000",
  "analysis": {
    "detected_language": "en",
    "semantic_entropy": 0.18,
    "llm_judge_score": 8.2,
    "contradictions": [],
    "vocabulary_stats": {
      "complexity": 0.6,
      "consistency": 0.9
    }
  },
  "patches_applied": ["clarity_1", "structure_2"],
  "export_timestamp": "2025-08-16T10:30:00Z"
}
```

---

## üìö Prompt-base Management

### POST /prompt-base/add

Adds a prompt to the knowledge base.

**Request Body:**
```json
{
  "name": "Python Fibonacci Function",
  "description": "Template for recursive fibonacci implementation",
  "content": "Write a Python function using recursion...",
  "format_type": "text",
  "language": "en",
  "tags": ["python", "recursion", "algorithms"]
}
```

### GET /prompt-base/prompts

Lists prompts with filtering options.

**Query Parameters:**
- `tags`: Filter by tags (e.g., `?tags=python,algorithms`)
- `language`: Filter by language (e.g., `?language=en`)
- `format_type`: Filter by format (e.g., `?format_type=text`)
- `skip`: Pagination offset
- `limit`: Number of results (max 100)

### GET /prompt-base/search

Search prompts by content or name.

**Query Parameters:**
- `q`: Search query
- `limit`: Number of results (default 10)

### POST /prompt-base/check

Checks prompt for conflicts with existing prompts.

**Response:**
```json
{
  "conflicts": [
    {
      "prompt_id": "existing-prompt-123",
      "conflict_type": "similar_content",
      "score": 0.85,
      "suggestion": "Consider creating a 'depends_on' relationship"
    }
  ],
  "overall_score": 0.3
}
```

---

## üè• System Health

### GET /healthz

Health check endpoint.

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2025-08-16T10:30:00Z",
  "services": {
    "database": "connected",
    "llm": "operational",
    "embeddings": "operational"
  }
}
```

---

## üìã Data Schemas

### PromptInput
```typescript
{
  content: string;           // Prompt text content
  format_type: "auto" | "text" | "markdown" | "xml";
}
```

### Patch
```typescript
{
  id: string;               // Unique patch identifier
  type: "safe" | "risky";   // Safety classification
  category: "clarity" | "structure" | "quality";
  description: string;      // Human-readable description
  original: string;         // Original text excerpt
  improved: string;         // Suggested improvement
  rationale: string;        // Explanation for change
  confidence: number;       // Confidence score (0.0-1.0)
}
```

### ClarifyQuestion
```typescript
{
  id: string;               // Question identifier
  text: string;             // Question content
  category: "scope" | "constraints" | "context" | "format";
  priority: "critical" | "important" | "optional";
}
```

---

## üîí Error Handling

All endpoints return standardized error responses:

```json
{
  "detail": "Error description",
  "error_code": "VALIDATION_ERROR",
  "timestamp": "2025-08-16T10:30:00Z"
}
```

**Common HTTP Status Codes:**
- `200`: Success
- `400`: Bad Request (validation error)
- `404`: Not Found
- `422`: Unprocessable Entity
- `500`: Internal Server Error

---

## üöÄ Quick Start

```bash
# Start the system
cd infra && docker compose up -d

# Health check
curl http://localhost:8000/healthz

# Analyze a prompt
curl -X POST http://localhost:8000/analyze \
  -H "Content-Type: application/json" \
  -d '{"prompt": {"content": "Write Python code", "format_type": "auto"}}'

# Apply improvements
curl -X POST http://localhost:8000/apply \
  -H "Content-Type: application/json" \
  -d '{"prompt_id": "uuid", "apply_all_safe": true}'
```

---

## üìä Performance

- **Analysis time**: 35-40 seconds for complete pipeline
- **Concurrent requests**: Supported via async processing
- **Semantic entropy**: 8-sample analysis with embeddings
- **LLM integration**: OpenAI gpt-4o-mini for cost efficiency

**Rate Limits**: Respect OpenAI API limits (~3 requests/second)
